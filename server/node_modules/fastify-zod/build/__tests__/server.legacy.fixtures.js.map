{"version":3,"file":"server.legacy.fixtures.js","names":["createLegacyTestServer","fastifyOptions","buildJsonSchemasOptions","swaggerOptions","f","fastify","register","fastifySwagger","withRefResolver","$ref","schemas","buildJsonSchemas","models","schema","addSchema","state","todoItems","get","operationId","response","done","filter","item","inProgress","todo","post","body","nextItem","some","prevItem","id","BadRequest","put","params","NotFound","map"],"sources":["../../src/__tests__/server.legacy.fixtures.ts"],"sourcesContent":["import fastify, { FastifyInstance, FastifyServerOptions } from \"fastify\";\nimport fastifySwagger, { FastifyDynamicSwaggerOptions } from \"@fastify/swagger\";\nimport { NotFound, BadRequest } from \"http-errors\";\n\nimport { buildJsonSchemas, withRefResolver } from \"..\";\nimport { BuildJsonSchemasOptions } from \"../JsonSchema\";\n\nimport {\n  models,\n  TodoItem,\n  TodoItemId,\n  TodoItems,\n  TodoItemsGroupedByStatus,\n} from \"./models.fixtures\";\n\nexport const createLegacyTestServer = (\n  fastifyOptions: FastifyServerOptions,\n  buildJsonSchemasOptions: BuildJsonSchemasOptions,\n  swaggerOptions: FastifyDynamicSwaggerOptions,\n): FastifyInstance => {\n  const f = fastify(fastifyOptions);\n\n  f.register(fastifySwagger, withRefResolver(swaggerOptions));\n\n  const { $ref, schemas } = buildJsonSchemas(models, buildJsonSchemasOptions);\n\n  for (const schema of schemas) {\n    f.addSchema(schema);\n  }\n\n  const state: TodoItems = {\n    todoItems: [],\n  };\n\n  f.get<{\n    Reply: TodoItems;\n  }>(\n    `/item`,\n    {\n      schema: {\n        operationId: `getTodoItems`,\n        response: {\n          200: $ref(`TodoItems`),\n        },\n      },\n    },\n    async () => state,\n  );\n\n  f.get<{\n    Reply: TodoItemsGroupedByStatus;\n  }>(\n    `/item/grouped-by-status`,\n    {\n      schema: {\n        operationId: `getTodoItemsGroupedByStatus`,\n        response: {\n          200: $ref(`TodoItemsGroupedByStatus`),\n        },\n      },\n    },\n    async () => ({\n      done: state.todoItems.filter((item) => item.state === `done`),\n      inProgress: state.todoItems.filter(\n        (item) => item.state === `in progress`,\n      ),\n      todo: state.todoItems.filter((item) => item.state === `todo`),\n    }),\n  );\n\n  f.post<{\n    Body: TodoItem;\n    Reply: TodoItems;\n  }>(\n    `/item`,\n    {\n      schema: {\n        operationId: `postTodoItem`,\n        body: $ref(`TodoItem`),\n        response: {\n          200: $ref(`TodoItems`),\n        },\n      },\n    },\n    async ({ body: nextItem }) => {\n      if (state.todoItems.some((prevItem) => prevItem.id === nextItem.id)) {\n        throw new BadRequest(`item already exists`);\n      }\n      state.todoItems = [...state.todoItems, nextItem];\n      return state;\n    },\n  );\n\n  f.put<{\n    Body: TodoItem;\n    Params: TodoItemId;\n    Reply: TodoItem;\n  }>(\n    `/item/:id`,\n    {\n      schema: {\n        operationId: `putTodoItem`,\n        body: $ref(`TodoItem`),\n        params: $ref(`TodoItemId`),\n        response: {\n          200: $ref(`TodoItem`),\n        },\n      },\n    },\n    async ({ params: { id }, body: nextItem }) => {\n      if (!state.todoItems.some((prevItem) => prevItem.id === id)) {\n        throw new NotFound(`no such item`);\n      }\n      state.todoItems = state.todoItems.map((prevItem) =>\n        prevItem.id === id ? nextItem : prevItem,\n      );\n      return nextItem;\n    },\n  );\n\n  return f;\n};\n"],"mappings":"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"}